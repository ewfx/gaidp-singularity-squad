<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Regulatory Compliance Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.2/dist/jsoneditor.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.2/dist/jsoneditor.min.js"></script>
    <style>
      .sidebar {
        transition: all 0.3s;
      }
      .sidebar:hover {
        width: 250px;
      }
      .sidebar:hover .sidebar-text {
        display: inline-block;
      }
      .sidebar-text {
        display: none;
        transition: all 0.3s;
      }
      .content {
        transition: all 0.3s;
      }
      .sidebar:hover + .content {
        margin-left: 250px;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease-in-out;
        z-index: 1000;
      }
      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }
      .toast.success {
        background-color: #10b981;
      }
      .toast.error {
        background-color: #ef4444;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50"
    >
      <div class="flex items-center justify-center h-full">
        <div class="bg-white p-8 rounded-lg shadow-xl">
          <div class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="text-center mt-4 text-gray-700">
              Processing your document...
            </p>
            <div class="mt-4 w-64 bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full animate-pulse"></div>
            </div>
            <p class="text-sm text-gray-500 mt-2">
              This may take a few minutes
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- JSON Viewer Modal -->
    <div id="jsonModal" class="modal">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Rulebook Details</h2>
          <button
            onclick="closeJsonModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="jsoneditor" style="height: 500px"></div>
      </div>
    </div>

    <div class="flex h-screen">
      <!-- Sidebar -->
      <div
        class="sidebar bg-gray-900 text-white w-20 fixed h-full flex flex-col items-center py-4"
      >
        <div class="mb-8">
          <i class="fas fa-shield-alt text-3xl"></i>
          <span class="sidebar-text ml-2">Compliance Hub</span>
        </div>
        <nav class="flex-1 w-full">
          <a
            href="#"
            class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white"
          >
            <i class="fas fa-book w-6"></i>
            <span class="sidebar-text">Rulebooks</span>
          </a>
          <a
            href="#"
            class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white"
          >
            <i class="fas fa-file-csv w-6"></i>
            <span class="sidebar-text">Validation</span>
          </a>
          <a
            href="#"
            class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white"
          >
            <i class="fas fa-chart-bar w-6"></i>
            <span class="sidebar-text">Analytics</span>
          </a>
          <a
            href="#"
            class="flex items-center px-4 py-3 text-gray-300 hover:bg-gray-800 hover:text-white"
          >
            <i class="fas fa-cog w-6"></i>
            <span class="sidebar-text">Settings</span>
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="content ml-20 flex-1 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-2xl font-bold text-gray-800">Rulebook Management</h1>
          <button
            onclick="openUploadModal()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center"
          >
            <i class="fas fa-plus mr-2"></i>
            Upload New Rulebook
          </button>
        </div>

        <!-- Rulebooks List -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="overflow-x-auto">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gray-50">
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Name
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Description
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Status
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Created At
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for rulebook in rulebooks %}
                <tr class="hover:bg-gray-50 transition-colors duration-200">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-10 w-10">
                        <div
                          class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center"
                        >
                          <i class="fas fa-book text-blue-600"></i>
                        </div>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">
                          {{ rulebook.rulebook_name }}
                        </div>
                        <div class="text-sm text-gray-500">
                          {{ rulebook.original_filename }}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-gray-900">
                      {{ rulebook.description }}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      <span class="inline-flex items-center">
                        <i class="fas fa-file-pdf text-red-500 mr-1"></i>
                        {{ (rulebook.file_size / 1024 / 1024)|round(2) }} MB
                      </span>
                      <span class="ml-2 inline-flex items-center">
                        <i class="fas fa-list-check text-green-500 mr-1"></i>
                        {{ rulebook.rules|length }} Rules
                      </span>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if rulebook.status == 'COMPLETED' %} bg-green-100 text-green-800 {% elif rulebook.status == 'PROCESSING' %} bg-yellow-100 text-yellow-800 {% elif rulebook.status == 'FAILED' %} bg-red-100 text-red-800 {% else %} bg-gray-100 text-gray-800 {% endif %}"
                    >
                      {{ rulebook.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ rulebook.created_at }}
                  </td>
                  <td
                    class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
                  >
                    <button
                      onclick="viewRules('{{ rulebook.uuid }}')"
                      class="text-blue-600 hover:text-blue-900 mr-3"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                    <button
                      onclick="deleteRulebook('{{ rulebook.uuid }}')"
                      class="text-red-600 hover:text-red-900"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div
      id="uploadModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
      >
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            Upload New Rulebook
          </h3>
          <form id="uploadForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Rulebook Name</label
              >
              <input
                type="text"
                name="rulebook_name"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                placeholder="e.g., Basel III, MiFID II"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >PDF File</label
              >
              <div
                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"
              >
                <div class="space-y-1 text-center w-full">
                  <div id="filePreview" class="hidden">
                    <div
                      class="flex items-center justify-center space-x-2 text-gray-600"
                    >
                      <i class="fas fa-file-pdf text-2xl text-red-500"></i>
                      <span id="fileName" class="text-sm truncate"></span>
                    </div>
                    <button
                      type="button"
                      onclick="clearFile()"
                      class="mt-2 text-sm text-red-600 hover:text-red-800"
                    >
                      <i class="fas fa-times mr-1"></i>Remove
                    </button>
                  </div>
                  <div id="uploadPrompt">
                    <i class="fas fa-file-pdf text-3xl text-gray-400"></i>
                    <div class="flex text-sm text-gray-600">
                      <label
                        for="file-upload"
                        class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500"
                      >
                        <span>Upload a file</span>
                        <input
                          id="file-upload"
                          name="file"
                          type="file"
                          class="sr-only"
                          accept=".pdf"
                          required
                        />
                      </label>
                      <p class="pl-1">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500">PDF up to 10MB</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex justify-end space-x-3">
              <button
                type="button"
                onclick="closeUploadModal()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
              >
                Upload
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Rules Modal -->
    <div
      id="rulesModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white"
      >
        <div class="mt-3">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Rulebook Rules</h3>
            <button
              onclick="closeRulesModal()"
              class="text-gray-400 hover:text-gray-500"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="rulesContent" class="space-y-4 max-h-[70vh] overflow-y-auto">
            <!-- Rules will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let jsonEditor = null;

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => {
          toast.className = "toast";
        }, 5000);
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
      }

      function openUploadModal() {
        document.getElementById("uploadModal").classList.remove("hidden");
      }

      function closeUploadModal() {
        document.getElementById("uploadModal").classList.add("hidden");
      }

      function openJsonModal() {
        document.getElementById("jsonModal").style.display = "block";
      }

      function closeJsonModal() {
        document.getElementById("jsonModal").style.display = "none";
      }

      function viewRulebook(uuid) {
        showLoading();
        fetch(`/rulebooks/rulebook/${uuid}`)
          .then((response) => response.json())
          .then((data) => {
            hideLoading();
            if (!jsonEditor) {
              const container = document.getElementById("jsoneditor");
              const options = {
                mode: "view",
                mainMenuBar: false,
                navigationBar: false,
                statusBar: false,
                theme: "ace/theme/monokai",
                onEditable: function () {
                  return false;
                },
              };
              jsonEditor = new JSONEditor(container, options);
            }
            jsonEditor.set(data);
            openJsonModal();
          })
          .catch((error) => {
            hideLoading();
            showToast("Error loading rulebook details", "error");
          });
      }

      function deleteRulebook(uuid) {
        if (confirm("Are you sure you want to delete this rulebook?")) {
          showLoading();
          fetch(`/rulebooks/rulebook/${uuid}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              hideLoading();
              if (data.success) {
                showToast("Rulebook deleted successfully");
                window.location.reload();
              } else {
                showToast("Error deleting rulebook", "error");
              }
            })
            .catch((error) => {
              hideLoading();
              showToast("Error deleting rulebook", "error");
            });
        }
      }

      // File upload handling
      const fileInput = document.getElementById("file-upload");
      const filePreview = document.getElementById("filePreview");
      const uploadPrompt = document.getElementById("uploadPrompt");
      const fileName = document.getElementById("fileName");

      fileInput.addEventListener("change", handleFileSelect);

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          if (file.type !== "application/pdf") {
            showToast("Only PDF files are allowed", "error");
            fileInput.value = "";
            return;
          }
          if (file.size > 10 * 1024 * 1024) {
            showToast("File size must be less than 10MB", "error");
            fileInput.value = "";
            return;
          }
          updateFilePreview(file);
        }
      }

      function updateFilePreview(file) {
        fileName.textContent = file.name;
        filePreview.classList.remove("hidden");
        uploadPrompt.classList.add("hidden");
      }

      function clearFile() {
        fileInput.value = "";
        filePreview.classList.add("hidden");
        uploadPrompt.classList.remove("hidden");
      }

      // Drag and drop handling
      const dropZone = document.querySelector(".border-dashed");
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        dropZone.classList.add("border-blue-500");
      }

      function unhighlight(e) {
        dropZone.classList.remove("border-blue-500");
      }

      dropZone.addEventListener("drop", handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type !== "application/pdf") {
            showToast("Only PDF files are allowed", "error");
            return;
          }
          if (file.size > 10 * 1024 * 1024) {
            showToast("File size must be less than 10MB", "error");
            return;
          }
          fileInput.files = files;
          updateFilePreview(file);
        }
      }

      // Form submission
      document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          showLoading();
          const formData = new FormData(this);

          fetch("/rulebooks/upload-pdf", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              hideLoading();
              if (data.success) {
                showToast(data.message);
                closeUploadModal();
                window.location.reload();
              } else {
                showToast("Error uploading rulebook", "error");
              }
            })
            .catch((error) => {
              hideLoading();
              showToast("Error uploading rulebook", "error");
            });
        });

      function viewRules(uuid) {
        showLoading();
        fetch(`/rulebooks/rulebook/${uuid}`)
          .then((response) => response.json())
          .then((data) => {
            hideLoading();
            if (data) {
              const rulesContent = document.getElementById("rulesContent");
              rulesContent.innerHTML = "";

              // Create a table for rules
              const table = document.createElement("table");
              table.className = "min-w-full divide-y divide-gray-200";
              table.innerHTML = `
                <thead>
                  <tr class="bg-gray-50">
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Column Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Regex Pattern</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${data.rules
                    .map(
                      (rule) => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rule.column_name}</td>
                      <td class="px-6 py-4 text-sm text-gray-500">${rule.description}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${rule.regex_pattern}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              `;

              rulesContent.appendChild(table);
              document.getElementById("rulesModal").classList.remove("hidden");
            } else {
              showToast("Error loading rules", "error");
            }
          })
          .catch((error) => {
            hideLoading();
            showToast("Error loading rules", "error");
          });
      }

      function closeRulesModal() {
        document.getElementById("rulesModal").classList.add("hidden");
      }
    </script>
  </body>
</html>
