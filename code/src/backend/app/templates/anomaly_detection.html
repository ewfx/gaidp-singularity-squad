<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anomaly Detection - Compliance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/static/4784338.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css"
    />
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-3.5.1.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"
    ></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        overflow: hidden;
      }

      .main-container {
        height: 100vh;
        overflow: hidden;
        display: flex;
      }

      .sidebar {
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        width: 16rem;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        overflow-y: auto;
      }

      .content-area {
        flex: 1;
        margin-left: 16rem;
        overflow-y: auto;
        height: 100vh;
        background-color: #f8fafc;
      }

      .upload-section {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        z-index: 10;
      }

      .upload-button {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: #3b82f6;
        color: white;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .upload-button:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .upload-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .upload-modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        position: relative;
      }

      .drop-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        background-color: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .drop-zone.dragover {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }

      .chart-container {
        height: 300px;
        min-height: 300px;
        max-height: 300px;
        overflow: hidden;
      }

      .sidebar {
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      }

      .nav-link {
        transition: all 0.3s ease;
      }

      .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        border-left: 4px solid #3b82f6;
      }

      .loader {
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #3b82f6;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .anomaly-card {
        transition: all 0.3s ease;
      }

      .anomaly-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .dataTables_wrapper .dataTables_length select,
      .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin: 0.5rem;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #3b82f6 !important;
        color: white !important;
        border: 1px solid #3b82f6;
      }

      .dt-buttons .dt-button {
        background-color: #3b82f6 !important;
        color: white !important;
        border: none !important;
        border-radius: 0.375rem !important;
        padding: 0.5rem 1rem !important;
        margin-right: 0.5rem !important;
      }

      .anomaly-row {
        background-color: #fee2e2 !important;
      }

      .stat-card {
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 2rem;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 1000px;
        position: relative;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h2 {
        margin: 0;
        color: #1f2937;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .close {
        color: #6b7280;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
        padding: 0.5rem;
        border-radius: 0.375rem;
      }

      .close:hover {
        color: #1f2937;
        background-color: #f3f4f6;
      }

      .modal-body {
        max-height: calc(90vh - 8rem);
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .transaction-detail {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
      }

      .transaction-detail:hover {
        background: #f1f5f9;
        transform: translateX(4px);
      }

      .transaction-detail label {
        font-weight: 600;
        color: #4b5563;
        font-size: 0.875rem;
      }

      .transaction-detail span {
        color: #1f2937;
        font-size: 0.875rem;
      }

      .transaction-detail.highlight {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
      }

      .transaction-detail.warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
      }

      .transaction-detail.danger {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
      }

      .modal-button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
      }

      .modal-button.primary {
        background-color: #3b82f6;
        color: white;
        border: none;
      }

      .modal-button.primary:hover {
        background-color: #2563eb;
      }

      .modal-button.secondary {
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
      }

      .modal-button.secondary:hover {
        background-color: #e5e7eb;
      }

      @media (max-width: 768px) {
        .modal-content {
          width: 95%;
          margin: 1% auto;
          padding: 1rem;
        }

        .transaction-detail {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .chart-container {
          height: 250px;
          min-height: 250px;
          max-height: 250px;
        }
      }

      @media (max-width: 768px) {
        .upload-section {
          position: relative;
          top: 0;
          right: 0;
          width: 100%;
          margin-bottom: 1rem;
        }

        .drop-zone {
          width: 100%;
        }

        .chart-container {
          height: 200px;
          min-height: 200px;
          max-height: 200px;
        }
      }

      .data-table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        table-layout: fixed;
      }

      .data-table th,
      .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .data-table tr:hover {
        background-color: #f8f9fa;
      }

      .data-table .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
        text-align: center;
        min-width: 80px;
      }

      .status-normal {
        background-color: #e8f5e9;
        color: #2e7d32;
      }

      .status-anomaly {
        background-color: #ffebee;
        color: #c62828;
      }

      .view-details-btn {
        background-color: #3b82f6;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s;
      }

      .view-details-btn:hover {
        background-color: #2563eb;
      }

      /* DataTable specific styles */
      .dataTables_wrapper {
        width: 100%;
      }

      .dataTables_length,
      .dataTables_filter {
        margin-bottom: 1rem;
      }

      .dataTables_info,
      .dataTables_paginate {
        margin-top: 1rem;
      }

      .dataTables_paginate .paginate_button {
        padding: 6px 12px;
        margin: 0 2px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        background: white;
        color: #4b5563;
      }

      .dataTables_paginate .paginate_button.current {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #3b82f6;
      }

      .dataTables_paginate .paginate_button:hover {
        background: #f3f4f6;
        border-color: #e2e8f0;
      }

      .dataTables_filter input {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        width: 200px;
      }

      .dataTables_length select {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin: 0 8px;
      }

      /* Column widths */
      .data-table th:nth-child(1),
      .data-table td:nth-child(1) { width: 12%; } /* Customer ID */
      .data-table th:nth-child(2),
      .data-table td:nth-child(2) { width: 12%; } /* Internal ID */
      .data-table th:nth-child(3),
      .data-table td:nth-child(3) { width: 20%; } /* Obligor Name */
      .data-table th:nth-child(4),
      .data-table td:nth-child(4) { width: 12%; } /* Credit Facility Type */
      .data-table th:nth-child(5),
      .data-table td:nth-child(5) { width: 12%; } /* Amount */
      .data-table th:nth-child(6),
      .data-table td:nth-child(6) { width: 8%; } /* Country */
      .data-table th:nth-child(7),
      .data-table td:nth-child(7) { width: 8%; } /* Risk Rating */
      .data-table th:nth-child(8),
      .data-table td:nth-child(8) { width: 8%; } /* Status */
      .data-table th:nth-child(9),
      .data-table td:nth-child(9) { width: 8%; } /* Actions */

      /* Responsive adjustments */
      @media (max-width: 1024px) {
        .data-table th,
        .data-table td {
          padding: 8px 12px;
          font-size: 13px;
        }
        
        .data-table .status-badge {
          padding: 3px 6px;
          font-size: 11px;
          min-width: 70px;
        }
        
        .view-details-btn {
          padding: 4px 8px;
          font-size: 11px;
        }
      }

      @media (max-width: 768px) {
        .data-table-container {
          margin-top: 10px;
        }
        
        .dataTables_filter input {
          width: 150px;
        }
        
        .dataTables_length select {
          padding: 4px 8px;
        }
      }

      #chartModal .modal-content {
        max-width: none;
        max-height: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        z-index: 1100;
        margin: 0;
        padding: 0;
        border-radius: 0;
      }

      #chartModal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        position: sticky;
        top: 0;
        z-index: 1;
        padding: 1rem 2rem;
        border-bottom: 1px solid #e5e7eb;
      }

      #chartModal .modal-body {
        height: calc(100vh - 4rem);
        padding: 0;
        overflow: hidden;
      }

      #expandedChart {
        width: 100% !important;
        height: 100% !important;
      }

      #chartModal .close {
        font-size: 1.5rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      #chartModal .close:hover {
        background-color: #f3f4f6;
      }

      .view-icon-btn {
        background: none;
        border: none;
        color: #3b82f6;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .view-icon-btn:hover {
        background-color: #eff6ff;
        color: #2563eb;
        transform: scale(1.1);
      }

      .view-icon-btn i {
        font-size: 16px;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar w-64 min-h-screen flex flex-col">
        <div class="p-6">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center"
            >
              <i class="fas fa-shield-alt text-white text-xl"></i>
            </div>
            <a href="/">
            <span class="text-white text-xl font-semibold"
              >Compliance Portal</span
            </a>
            
          </div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-1">
          <a
            href="/dashboard"
            class="nav-link flex items-center px-4 py-3 text-gray-300 rounded-lg"
          >
            <i class="fas fa-home w-6"></i>
            <span>Rulebook Management</span>
          </a>

          <a
            href="/data-validation"
            class="nav-link flex items-center px-4 py-3 text-gray-300 rounded-lg"
          >
            <i class="fas fa-check-circle w-6"></i>
            <span>Data Validation</span>
          </a>
          <a
            href="/anomaly-detection"
            class="nav-link active flex items-center px-4 py-3 text-gray-300 rounded-lg"
          >
            <i class="fas fa-exclamation-triangle w-6"></i>
            <span>Anomaly Detection</span>
          </a>
        </nav>
        <div class="p-4 border-t border-gray-700">
          <div class="flex items-center space-x-3">
            <img
              src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS31IIY-k8jbqZOMxsqqUY4VfN3vcNwM3iyKg&s"
              class="w-8 h-8 bg-gray-700 rounded-full"
            />
            <div class="flex-1">
              <p class="text-sm text-white font-medium">Singularity Squad</p>
              <p class="text-xs text-gray-400">Admin</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="content-area">
        <!-- Top Bar -->
        <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <h1 class="text-2xl font-bold text-gray-900">
                Anomaly Detection
              </h1>
              <span
                class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
              >
               Development
              </span>
            </div>
            <div class="flex items-center space-x-4">
              <button class="text-gray-500 hover:text-gray-700">
                <!-- <i class="fas fa-bell text-xl"></i> -->
              </button>
              <button class="text-gray-500 hover:text-gray-700">
                <!-- <i class="fas fa-search text-xl"></i> -->
              </button>
            </div>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="p-6">
          <!-- Upload Section -->
          <div class="upload-section">
            <button id="uploadBtn" class="upload-button">
              <i class="fas fa-upload mr-2"></i>
              Upload Data
            </button>
          </div>

          <!-- Upload Modal -->
          <div id="uploadModal" class="upload-modal">
            <div class="upload-modal-content">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">
                  Upload Transaction Data
                </h2>
                <button
                  class="text-gray-500 hover:text-gray-700"
                  onclick="closeUploadModal()"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">
                  Upload your CSV file containing transaction data for anomaly
                  detection.
                </p>
                <div id="dropZone" class="drop-zone">
                  <input
                    type="file"
                    id="fileInput"
                    class="hidden"
                    accept=".csv"
                    onchange="handleFileSelect(event)"
                  />
                  <div class="space-y-2">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                    <p class="text-sm font-medium text-gray-700">
                      Drag and drop your CSV file here
                    </p>
                    <p class="text-xs text-gray-500">or click to browse</p>
                  </div>
                </div>
                <div id="selectedFile" class="mt-2 hidden">
                  <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-2">
                      <i class="fas fa-file-csv text-blue-500"></i>
                      <span class="text-sm text-gray-700" id="fileName"></span>
                    </div>
                    <button onclick="removeSelectedFile()" class="text-gray-500 hover:text-red-500">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div id="uploadStatus" class="hidden">
                <div class="flex items-center space-x-2 p-2 rounded bg-blue-50">
                  <div class="loader" id="uploadLoader"></div>
                  <span id="uploadMessage" class="text-sm text-blue-700"></span>
                </div>
              </div>
              <div class="flex justify-end space-x-3 mt-4">
                <button
                  class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
                  onclick="closeUploadModal()"
                >
                  Cancel
                </button>
                <button
                  id="uploadSubmitBtn"
                  class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                  onclick="submitFile()"
                  disabled
                >
                  Upload
                </button>
              </div>
            </div>
          </div>

          <!-- Statistics Grid -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"
          >
            <div class="bg-white rounded-lg shadow p-6 stat-card">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                  Total Records
                </h3>
                <i class="fas fa-database text-blue-500 text-xl"></i>
              </div>
              <div
                class="text-3xl font-bold text-gray-900 mb-2"
                id="totalRecords"
              >
                -
              </div>
              <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-chart-line mr-2"></i>
                <span>Total transactions analyzed</span>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 stat-card">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Anomalies</h3>
                <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
              </div>
              <div
                class="text-3xl font-bold text-gray-900 mb-2"
                id="anomalyCount"
              >
                -
              </div>
              <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>Detected anomalies</span>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 stat-card">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                  Detection Rate
                </h3>
                <i class="fas fa-percentage text-green-500 text-xl"></i>
              </div>
              <div
                class="text-3xl font-bold text-gray-900 mb-2"
                id="detectionRate"
              >
                -
              </div>
              <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-chart-pie mr-2"></i>
                <span>Anomaly percentage</span>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 stat-card">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                  Last Updated
                </h3>
                <i class="fas fa-clock text-yellow-500 text-xl"></i>
              </div>
              <div
                class="text-3xl font-bold text-gray-900 mb-2"
                id="lastUpdated"
              >
                -
              </div>
              <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-history mr-2"></i>
                <span>Last analysis time</span>
              </div>
            </div>
          </div>

          <!-- Visualization Grid -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                Anomaly Distribution Over Time
              </h3>
              <div id="timeSeriesPlot" class="chart-container"></div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                Pattern Analysis
              </h3>
              <div id="patternPlot" class="chart-container"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                Regional Distribution
              </h3>
              <div id="regionalPlot" class="chart-container"></div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                Transaction Type Analysis
              </h3>
              <div id="transactionTypePlot" class="chart-container"></div>
            </div>
          </div>

          <!-- Data Table Section -->
          <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              Detailed Anomaly Analysis
            </h3>
            <div class="data-table-container">
              <table id="anomalyTable" class="data-table">
                <thead>
                  <tr>
                    <th>Customer ID</th>
                    <th>Internal ID</th>
                    <th>Obligor Name</th>
                    <th>Credit Facility Type</th>
                    <th>Amount (INR)</th>
                    <th>Country</th>
                    <th>Risk Rating</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="anomalyTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transaction Details Modal -->
    <div id="transactionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Transaction Details</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
        <div id="transactionDetails"></div>
        </div>
      </div>
    </div>

    <!-- Add this new modal for expanded charts -->
    <div id="chartModal" class="modal">
      <div class="modal-content" style="width: 100%; height: 100%; margin: 0; padding: 0; border-radius: 0;">
        <div class="modal-header" style="padding: 1rem 2rem; background: white; border-bottom: 1px solid #e5e7eb;">
          <h2 id="expandedChartTitle" class="text-xl font-semibold text-gray-900"></h2>
          <span class="close" onclick="closeChartModal()" style="font-size: 1.5rem; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer;">&times;</span>
        </div>
        <div class="modal-body" style="height: calc(100% - 4rem); padding: 0;">
          <div id="expandedChart" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>

    <script>
      // Upload Modal Functionality
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadModal = document.getElementById("uploadModal");

      uploadBtn.onclick = function () {
        uploadModal.style.display = "block";
      };

      function closeUploadModal() {
        uploadModal.style.display = "none";
      }

      window.onclick = function (event) {
        if (event.target == uploadModal) {
          closeUploadModal();
        } else if (event.target == modal) {
          closeModal();
        }
      };

      // File Upload Handling
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const uploadStatus = document.getElementById("uploadStatus");
      const uploadLoader = document.getElementById("uploadLoader");
      const uploadMessage = document.getElementById("uploadMessage");
      const selectedFile = document.getElementById("selectedFile");
      const fileName = document.getElementById("fileName");
      const uploadSubmitBtn = document.getElementById("uploadSubmitBtn");
      let selectedFileData = null;

      // Click handler for drop zone
      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      // Drag and drop handlers
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });

      dropZone.addEventListener("drop", handleDrop, false);

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight(e) {
        dropZone.classList.add("dragover");
      }

      function unhighlight(e) {
        dropZone.classList.remove("dragover");
      }

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
      }

      function handleFiles(files) {
        if (files.length === 0) return;
        const file = files[0];
        if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
          alert("Please upload a CSV file");
          return;
        }
        
        selectedFileData = file;
        fileName.textContent = file.name;
        selectedFile.classList.remove("hidden");
        uploadSubmitBtn.disabled = false;
      }

      function removeSelectedFile() {
        selectedFileData = null;
        fileName.textContent = "";
        selectedFile.classList.add("hidden");
        uploadSubmitBtn.disabled = true;
        fileInput.value = "";
      }

      function submitFile() {
        if (!selectedFileData) return;
        uploadFile(selectedFileData);
      }

      function uploadFile(file) {
        uploadStatus.classList.remove("hidden");
        uploadLoader.style.display = "inline-block";
        uploadMessage.textContent = "Uploading file...";
        uploadMessage.style.color = "#3b82f6";

        const formData = new FormData();
        formData.append("transactions", file);

        // Show upload progress
        const progressBar = document.createElement("div");
        progressBar.className = "w-full bg-gray-200 rounded-full h-2.5 mt-2";
        progressBar.innerHTML = '<div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>';
        uploadStatus.appendChild(progressBar);

        // Simulate upload progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 5;
          if (progress <= 90) {
            progressBar.querySelector("div").style.width = `${progress}%`;
          }
        }, 200);

        // Create a new XMLHttpRequest for upload progress
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/anomalies/get-anomalies", true);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 90; // Use 90% for upload
            progressBar.querySelector("div").style.width = `${percentComplete}%`;
          }
        };

        xhr.onload = function() {
          clearInterval(progressInterval);
          if (xhr.status === 200) {
            try {
              const data = JSON.parse(xhr.responseText);
            if (data.error) {
              throw new Error(data.error);
            }
              progressBar.querySelector("div").style.width = "100%";
            uploadLoader.style.display = "none";
            uploadMessage.textContent = "File processed successfully!";
              uploadMessage.style.color = "#059669";
              
              // Add success icon
              const successIcon = document.createElement("i");
              successIcon.className = "fas fa-check-circle ml-2 text-green-500";
              uploadMessage.appendChild(successIcon);
              
            setTimeout(() => {
              updateDashboard(data);
              closeUploadModal();
            }, 1000);
            } catch (error) {
              throw new Error(error.message || "Error processing file");
            }
          } else {
            throw new Error(`HTTP error! status: ${xhr.status}`);
          }
        };

        xhr.onerror = function() {
          clearInterval(progressInterval);
            uploadLoader.style.display = "none";
          uploadMessage.textContent = "Error: Network error occurred. Please try again.";
            uploadMessage.style.color = "#dc2626";
          
          // Add error icon
          const errorIcon = document.createElement("i");
          errorIcon.className = "fas fa-exclamation-circle ml-2 text-red-500";
          uploadMessage.appendChild(errorIcon);
          
          console.error("Network error occurred");
        };

        xhr.send(formData);
      }

      function updateDashboard(data) {
        // Update statistics
        updateStatistics(data.statistics);
        
        // Update visualizations
        updateVisualizations(data);
        
        // Update data table
        updateDataTable(data.anomalies);
      }

      function updateStatistics(stats) {
        document.getElementById("totalRecords").textContent = stats.total_records;
        document.getElementById("anomalyCount").textContent = stats.anomaly_count;
        document.getElementById("detectionRate").textContent = `${stats.detection_rate.toFixed(2)}%`;
        document.getElementById("lastUpdated").textContent = stats.last_updated;
      }

      function updateVisualizations(data) {
        // Time Series Plot
        const timeSeriesData = [
          {
            x: data.time_series.timestamps,
            y: data.time_series.normal_count,
            name: "Normal Transactions",
            type: "scatter",
            mode: "lines",
            line: {
              shape: "spline",
              width: 3,
              color: "#60a5fa",
            },
            fill: "tonexty",
            fillcolor: "rgba(96, 165, 250, 0.1)",
                hovertemplate: "<b>%{x|%Y-%m-%d}</b><br>" +
                             "Normal: %{y}<br>" +
                             "<extra></extra>"
          },
          {
            x: data.time_series.timestamps,
            y: data.time_series.anomaly_count,
            name: "Anomalous Transactions",
            type: "scatter",
            mode: "lines+markers",
            line: {
              shape: "spline",
              width: 3,
              color: "#f87171",
            },
            marker: {
              size: 6,
              color: "#ef4444",
              line: {
                color: "#fff",
                width: 1,
              },
            },
            fill: "tonexty",
            fillcolor: "rgba(248, 113, 113, 0.1)",
                hovertemplate: "<b>%{x|%Y-%m-%d}</b><br>" +
                             "Anomalies: %{y}<br>" +
                             "<extra></extra>"
          },
        ];

        const timeSeriesLayout = {
          margin: { t: 20, r: 20, b: 40, l: 40 },
          xaxis: {
                title: "Date",
            type: "date",
                tickformat: "%Y-%m-%d",
            showgrid: true,
            gridcolor: "#e5e7eb",
            linecolor: "#e5e7eb",
                rangeslider: { visible: true },
                rangeselector: {
                    buttons: [
                        { count: 1, label: '1m', step: 'month', stepmode: 'backward' },
                        { count: 3, label: '3m', step: 'month', stepmode: 'backward' },
                        { count: 6, label: '6m', step: 'month', stepmode: 'backward' },
                        { step: 'all', label: 'All' }
                    ]
                }
          },
          yaxis: {
            title: "Number of Transactions",
            showgrid: true,
            gridcolor: "#e5e7eb",
            linecolor: "#e5e7eb",
            zeroline: false,
          },
          showlegend: true,
          legend: {
            x: 0,
            y: 1.1,
            orientation: "h",
                bgcolor: "rgba(255, 255, 255, 0.8)",
                bordercolor: "#e5e7eb",
                borderwidth: 1,
          },
          plot_bgcolor: "#ffffff",
          paper_bgcolor: "#ffffff",
          hovermode: "x unified",
            hoverlabel: {
                bgcolor: "#ffffff",
                font: { size: 14 },
                bordercolor: "#e5e7eb",
            },
        };

        // Regional Distribution Plot
        const regionalPlotData = [
          {
            x: data.regional_distribution.regions,
            y: data.regional_distribution.total_transactions,
            name: "Total Transactions",
            type: "bar",
            marker: {
              color: "#3b82f6",
            },
                hovertemplate: "<b>%{x}</b><br>" +
                             "Total: %{y}<br>" +
                             "<extra></extra>"
          },
          {
            x: data.regional_distribution.regions,
            y: data.regional_distribution.anomalies,
            name: "Anomalies",
            type: "bar",
            marker: {
              color: "#ef4444",
            },
                hovertemplate: "<b>%{x}</b><br>" +
                             "Anomalies: %{y}<br>" +
                             "<extra></extra>"
          },
        ];

        const regionalLayout = {
          margin: { t: 20, r: 20, b: 40, l: 40 },
          barmode: "group",
          xaxis: {
                title: "Country",
            showgrid: true,
            gridcolor: "#e5e7eb",
                tickangle: -45,
          },
          yaxis: {
            title: "Number of Transactions",
            showgrid: true,
            gridcolor: "#e5e7eb",
          },
          showlegend: true,
          legend: {
            x: 0,
            y: 1.1,
            orientation: "h",
                bgcolor: "rgba(255, 255, 255, 0.8)",
                bordercolor: "#e5e7eb",
                borderwidth: 1,
          },
          plot_bgcolor: "#ffffff",
          paper_bgcolor: "#ffffff",
            hoverlabel: {
                bgcolor: "#ffffff",
                font: { size: 14 },
                bordercolor: "#e5e7eb",
            },
        };

        // Transaction Type Plot
        const transactionTypePlotData = [
          {
            values: data.transaction_types.normal_count,
            labels: data.transaction_types.types,
            type: "pie",
            hole: 0.4,
            marker: {
                    colors: ["#3b82f6", "#34d399", "#f59e0b", "#8b5cf6", "#ec4899", "#14b8a6"],
            },
            textinfo: "label+percent",
            textposition: "outside",
                textfont: { size: 10 },
            automargin: true,
                hovertemplate: "<b>%{label}</b><br>" +
                             "Count: %{value}<br>" +
                             "Percentage: %{percent}<br>" +
                             "<extra></extra>"
          },
        ];

        const transactionTypeLayout = {
          margin: { t: 20, r: 20, b: 20, l: 20 },
            showlegend: true,
            legend: {
                orientation: "v",
                yanchor: "middle",
                y: 0.5,
                xanchor: "left",
                x: 0.02,
                bgcolor: "rgba(255, 255, 255, 0.8)",
                bordercolor: "#e5e7eb",
                borderwidth: 1,
            },
          annotations: [
            {
                    font: { size: 14, color: "#1f2937" },
              showarrow: false,
                    text: "Credit Facility Types",
                    x: -0.2,
              y: 0.5,
                    yref: 'paper',
                    xref: 'paper',
                    textangle: -90,
                    align: 'center',
                    valign: 'middle'
            },
          ],
          plot_bgcolor: "#ffffff",
          paper_bgcolor: "#ffffff",
            hoverlabel: {
                bgcolor: "#ffffff",
                font: { size: 12 },
                bordercolor: "#e5e7eb",
            },
        };

        // Pattern Analysis Plot
        const patternData = [
          {
            x: data.time_series.timestamps,
            y: data.time_series.anomaly_count.map(
              (val, i) => (val / (val + data.time_series.normal_count[i])) * 100
            ),
            name: "Anomaly Rate",
            type: "scatter",
            mode: "lines",
            line: {
              shape: "spline",
              width: 3,
              color: "#8b5cf6",
            },
                hovertemplate: "<b>%{x|%Y-%m-%d}</b><br>" +
                             "Rate: %{y:.2f}%<br>" +
                             "<extra></extra>"
          },
        ];

        const patternLayout = {
            margin: { t: 20, r: 20, b: 40, l: 40 },
          xaxis: {
                title: "Date",
            type: "date",
                tickformat: "%Y-%m-%d",
            showgrid: true,
            gridcolor: "#e5e7eb",
            linecolor: "#e5e7eb",
                rangeslider: { visible: true },
                rangeselector: {
                    buttons: [
                        { count: 1, label: '1m', step: 'month', stepmode: 'backward' },
                        { count: 3, label: '3m', step: 'month', stepmode: 'backward' },
                        { count: 6, label: '6m', step: 'month', stepmode: 'backward' },
                        { step: 'all', label: 'All' }
                    ]
                }
          },
          yaxis: {
            title: "Anomaly Rate (%)",
            showgrid: true,
            gridcolor: "#e5e7eb",
            linecolor: "#e5e7eb",
            zeroline: false,
            range: [0, 100],
          },
          showlegend: true,
          legend: {
            x: 0,
            y: 1.1,
            orientation: "h",
                bgcolor: "rgba(255, 255, 255, 0.8)",
                bordercolor: "#e5e7eb",
                borderwidth: 1,
          },
          plot_bgcolor: "#ffffff",
          paper_bgcolor: "#ffffff",
          hovermode: "x unified",
            hoverlabel: {
                bgcolor: "#ffffff",
                font: { size: 14 },
                bordercolor: "#e5e7eb",
            },
        };

        const config = {
          responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            modeBarButtonsToAdd: [{
                name: 'Download Plot',
                icon: Plotly.Icons.download,
                click: function(gd) {
                    Plotly.downloadImage(gd, {format: 'png', width: 800, height: 600, filename: 'plot'});
                }
            }],
        };

        // Add expand buttons to each chart container
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
          const chartId = container.id;
          const title = container.previousElementSibling.textContent;
          
          // Add expand button
          const expandButton = document.createElement('button');
          expandButton.className = 'absolute top-2 right-2 p-2 bg-white rounded-lg shadow-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500';
          expandButton.innerHTML = '<i class="fas fa-expand"></i>';
          expandButton.onclick = () => expandChart(chartId, title);
          container.style.position = 'relative';
          container.appendChild(expandButton);
        });

        // Plot all charts with data attributes
        const timeSeriesPlot = Plotly.newPlot("timeSeriesPlot", timeSeriesData, timeSeriesLayout, config);
        const patternPlot = Plotly.newPlot("patternPlot", patternData, patternLayout, config);
        const regionalPlot = Plotly.newPlot("regionalPlot", regionalPlotData, regionalLayout, config);
        const transactionTypePlot = Plotly.newPlot("transactionTypePlot", transactionTypePlotData, transactionTypeLayout, config);

        // Store plot data for expansion
        document.getElementById('timeSeriesPlot').setAttribute('data-plotly', JSON.stringify(timeSeriesData));
        document.getElementById('timeSeriesPlot').setAttribute('data-layout', JSON.stringify(timeSeriesLayout));
        
        document.getElementById('patternPlot').setAttribute('data-plotly', JSON.stringify(patternData));
        document.getElementById('patternPlot').setAttribute('data-layout', JSON.stringify(patternLayout));
        
        document.getElementById('regionalPlot').setAttribute('data-plotly', JSON.stringify(regionalPlotData));
        document.getElementById('regionalPlot').setAttribute('data-layout', JSON.stringify(regionalLayout));
        
        document.getElementById('transactionTypePlot').setAttribute('data-plotly', JSON.stringify(transactionTypePlotData));
        document.getElementById('transactionTypePlot').setAttribute('data-layout', JSON.stringify(transactionTypeLayout));
      }

      function updateDataTable(data) {
        anomalyTable.clear();
        
        data.forEach(anomaly => {
          anomalyTable.row.add([
            anomaly.customer_id || '-',
            anomaly.internal_id || '-',
            anomaly.obligor_name || '-',
            anomaly.credit_facility_type || '-',
            anomaly.utilized_exposure_global || '-',
            anomaly.country || '-',
            anomaly.obligor_internal_risk_rating || '-',
            anomaly.anomaly_label === 1 ? 'Anomaly' : 'Normal',
            `<button class="view-icon-btn" onclick="showTransactionDetails(${JSON.stringify(anomaly).replace(/"/g, '&quot;')})" title="View Details">
              <i class="fas fa-eye"></i>
            </button>`
          ]);
        });
        
        anomalyTable.draw();
      }

      // Modal functionality
      const modal = document.getElementById("transactionModal");
      const span = document.getElementsByClassName("close")[0];

      span.onclick = closeModal;
      window.onclick = function (event) {
        if (event.target == modal) {
          closeModal();
        }
      };

      function closeModal() {
        modal.style.display = "none";
      }

      function showTransactionDetails(transaction) {
        const detailsDiv = document.getElementById('transactionDetails');
        detailsDiv.innerHTML = '';
        
        // Group fields by category
        const categories = {
          'Basic Information': [
            'customer_id', 'internal_id', 'obligor_name', 'obligor_internal_risk_rating',
            'tin', 'country', 'industry_code', 'industry_code_type'
          ],
          'Credit Facility Details': [
            'internal_credit_facility_id', 'origination_date', 'maturity_date',
            'credit_facility_type', 'credit_facility_purpose', 'credit_facility_currency'
          ],
          'Exposure Information': [
            'committed_exposure_global', 'utilized_exposure_global',
            'probability_of_default', 'loss_given_default', 'exposure_at_default'
          ],
          'Financial Information': [
            'net_income_current', 'total_assets_current', 'long_term_debt',
            'current_assets_current', 'current_liabilities_current'
          ],
          'Additional Details': [
            'guarantor_flag', 'guarantor_name', 'guarantor_tin',
            'entity_name', 'entity_internal_risk_rating', 'anomaly_label'
          ]
        };

        // Create HTML for each category
        for (const [category, fields] of Object.entries(categories)) {
          const categoryFields = fields.filter(field => transaction[field] !== undefined);
          if (categoryFields.length > 0) {
            detailsDiv.innerHTML += `
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">${category}</h3>
                ${categoryFields.map(field => {
                  const value = transaction[field];
                  const formattedKey = field.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                  ).join(' ');
                  
                  let detailClass = 'transaction-detail';
                  if (field === 'risk_score') {
                    const score = parseFloat(value);
                    detailClass += score > 0.7 ? ' danger' : score > 0.4 ? ' warning' : ' highlight';
                  }

                  let formattedValue = value;
                  if (field.includes('exposure') || field.includes('amount')) {
                    formattedValue = new Intl.NumberFormat('en-IN', {
                      style: 'currency',
                      currency: 'INR'
                    }).format(value);
                  } else if (field.includes('date')) {
                    formattedValue = new Date(value).toLocaleString();
                  } else if (field === 'anomaly_label') {
                    formattedValue = value === 1 ? 'Anomaly' : 'Normal';
                  }

                  return `
                    <div class="${detailClass}">
                      <label>${formattedKey}:</label>
                      <span>${formattedValue || '-'}</span>
              </div>
                  `;
                }).join('')}
              </div>
            `;
          }
        }

        // Add action buttons
        detailsDiv.innerHTML += `
          <div class="modal-footer">
            <button class="modal-button secondary" onclick="closeModal()">Close</button>
            <button class="modal-button primary" onclick='exportTransactionDetails(${JSON.stringify(transaction)})'>
              <i class="fas fa-download mr-2"></i>Export Details
            </button>
          </div>
        `;

        modal.style.display = 'block';
      }

      // Add the exportTransactionDetails function separately
      function exportTransactionDetails(transaction) {
        try {
          // Group fields by category
          const categories = {
            'Basic Information': [
              'customer_id', 'internal_id', 'obligor_name', 'obligor_internal_risk_rating',
              'tin', 'country', 'industry_code', 'industry_code_type'
            ],
            'Credit Facility Details': [
              'internal_credit_facility_id', 'origination_date', 'maturity_date',
              'credit_facility_type', 'credit_facility_purpose', 'credit_facility_currency'
            ],
            'Exposure Information': [
              'committed_exposure_global', 'utilized_exposure_global',
              'probability_of_default', 'loss_given_default', 'exposure_at_default'
            ],
            'Financial Information': [
              'net_income_current', 'total_assets_current', 'long_term_debt',
              'current_assets_current', 'current_liabilities_current'
            ],
            'Additional Details': [
              'guarantor_flag', 'guarantor_name', 'guarantor_tin',
              'entity_name', 'entity_internal_risk_rating', 'anomaly_label'
            ]
          };

          // Create formatted content
          let content = 'Transaction Details Export\n';
          content += 'Generated on: ' + new Date().toLocaleString() + '\n\n';

          for (const [category, fields] of Object.entries(categories)) {
            content += `${category}\n`;
            content += '='.repeat(category.length) + '\n';
            
            fields.forEach(field => {
              if (transaction[field] !== undefined) {
                const formattedKey = field.split('_').map(word => 
                  word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                
                let value = transaction[field];
                
                // Format special fields
                if (field.includes('exposure') || field.includes('amount')) {
                  value = new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                  }).format(value);
                } else if (field.includes('date')) {
                  value = new Date(value).toLocaleString();
                } else if (field === 'anomaly_label') {
                  value = value === 1 ? 'Anomaly' : 'Normal';
                }
                
                content += `${formattedKey}: ${value}\n`;
              }
            });
            content += '\n';
          }

          // Create and trigger download
          const blob = new Blob([content], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `transaction_${transaction.internal_id || 'details'}_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error('Error exporting transaction details:', error);
          alert('Error exporting transaction details. Please try again.');
        }
      }

      // Initialize DataTable with enhanced features
      let anomalyTable = $("#anomalyTable").DataTable({
        dom: '<"flex flex-col md:flex-row justify-between items-center mb-4"<"flex items-center mb-2 md:mb-0"l><"flex items-center"f>>rt<"flex flex-col md:flex-row justify-between items-center mt-4"<"flex items-center mb-2 md:mb-0"i><"flex items-center"p>>',
        language: {
          search: "",
          searchPlaceholder: "Search transactions...",
          lengthMenu: "Show _MENU_ entries",
          info: "Showing _START_ to _END_ of _TOTAL_ entries",
          infoEmpty: "Showing 0 to 0 of 0 entries",
          infoFiltered: "(filtered from _MAX_ total entries)",
          paginate: {
            first: '<i class="fas fa-angle-double-left"></i>',
            previous: '<i class="fas fa-angle-left"></i>',
            next: '<i class="fas fa-angle-right"></i>',
            last: '<i class="fas fa-angle-double-left"></i>'
          }
        },
        pageLength: 10,
        responsive: true,
        order: [[7, "desc"]],
        stateSave: true,
        searching: true,
        processing: true,
        serverSide: false,
        columnDefs: [
          {
            targets: -1,
            orderable: false,
            className: "text-center"
          },
          {
            targets: 7,
            render: function (data, type, row) {
              let badgeClass = data === "Anomaly" ? "badge-danger" : "badge-success";
              return `<span class="badge ${badgeClass}">${data}</span>`;
            },
            className: "text-center"
          },
          {
            targets: 4,
            render: function (data, type, row) {
              return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
              }).format(data);
            }
          }
        ],
        createdRow: function (row, data, dataIndex) {
          if (data[7] === "Anomaly") {
            $(row).addClass("anomaly-row");
          }
        }
      });

      // Add custom styling for DataTable elements
      $('.dataTables_filter input').addClass('form-input w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent');
      $('.dataTables_length select').addClass('form-select w-24 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent');
      $('.dataTables_paginate .paginate_button').addClass('px-3 py-1 mx-1 rounded-lg border border-gray-300 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent');
      $('.dataTables_paginate .paginate_button.current').addClass('bg-blue-500 text-white border-blue-500 hover:bg-blue-600');
      $('.dataTables_info').addClass('text-sm text-gray-600');

      // Add these new functions for chart expansion
      function expandChart(chartId, title) {
        const chartModal = document.getElementById('chartModal');
        const expandedChartTitle = document.getElementById('expandedChartTitle');
        const expandedChart = document.getElementById('expandedChart');
        
        expandedChartTitle.textContent = title;
        
        // Clone the chart data and layout
        const chart = document.getElementById(chartId);
        const data = JSON.parse(chart.getAttribute('data-plotly'));
        const layout = JSON.parse(chart.getAttribute('data-layout'));
        
        // Calculate dimensions
        const modalWidth = window.innerWidth;
        const modalHeight = window.innerHeight - 64; // Subtract header height
        
        // Adjust layout for full screen
        layout.width = modalWidth;
        layout.height = modalHeight;
        
        // Adjust margins based on chart type
        if (chartId === 'transactionTypePlot') {
          // For pie chart, adjust margins to accommodate legend
          layout.margin = { 
            t: 40, 
            r: modalWidth * 0.2, // Reserve space for legend
            b: 40, 
            l: 40 
          };
          // Adjust legend position
          layout.legend = {
            ...layout.legend,
            x: 1.1,
            y: 0.5,
            yanchor: 'middle',
            xanchor: 'left'
          };
        } else if (chartId === 'regionalPlot') {
          // For bar chart, adjust margins to prevent label cutoff
          layout.margin = { 
            t: 40, 
            r: 40, 
            b: 80, // More space for x-axis labels
            l: 60 
          };
          // Adjust x-axis for better label display
          layout.xaxis = {
            ...layout.xaxis,
            tickangle: -45,
            automargin: true
          };
        } else {
          // For line charts, use standard margins
          layout.margin = { 
            t: 40, 
            r: 40, 
            b: 60, 
            l: 60 
          };
        }
        
        // Make sure all charts are responsive
        layout.autosize = true;
        
        // Plot the expanded chart
        Plotly.newPlot('expandedChart', data, layout, {
          responsive: true,
          displayModeBar: true,
          displaylogo: false,
          modeBarButtonsToRemove: ['lasso2d', 'select2d'],
          modeBarButtonsToAdd: [{
            name: 'Download Plot',
            icon: Plotly.Icons.download,
            click: function(gd) {
              Plotly.downloadImage(gd, {format: 'png', width: 1920, height: 1080, filename: 'plot'});
            }
          }],
        });
        
        // Add resize handler
        window.addEventListener('resize', function() {
          Plotly.Plots.resize('expandedChart');
        });
        
        chartModal.style.display = 'block';
      }

      function closeChartModal() {
        document.getElementById('chartModal').style.display = 'none';
      }
    </script>
  </body>
</html>
